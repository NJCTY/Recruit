<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>申请报名</title>

    <!-- Bootstrap -->
    <link href="__ROOT__/css/bootstrap.min.css" rel="stylesheet">
    <link href="__ROOT__/css/style.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <?php
    dump($recruitInfo);
    ?> 
    <div class="wrap">
      <!-- 导航栏 -->
      <nav class="navbar navbar-default navbar-inverse">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">个人中心</span>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav second-nav">
        <li class="nav-contain active"><a href="__URL__/changeDepartment" class="nav-link">申请报名</a></li>
        <li class="nav-contain"><a href="__URL__/changeInfo" class="nav-link">修改信息</a></li>
        <li class="nav-contain"><a href="__URL__/changePassword" class="nav-link">修改密码</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

      <div class="container tablecontain" id="main" >
          <div id="chooseAsso">
            <span>社团:</span>
            <select class="form-control tSelector" id="teamselect">
              <option>==请选择==</option>
              <option>科协</option>
              <option>外联</option>
              <option>办公室</option>
              <option>4</option>
              <option>5</option>
          </select>
          <button type="button" class="btn btn-default" id="depAdd">添加</button>
          </div>
          <div id="chooseTable">
            <!-- <button type="button" class="btn btn-default" id="depSave">保存</button> -->
            <div class="depWrap">
              <div class="depTable">
                <span>部门1</span>
                <select class="form-control tSelector" id="department_1">
                    
                    </select>
              </div>
              <div class="depTable">
                <span>部门2</span>
                <select class="form-control tSelector" id="department_2">
                      
                    </select>
              </div>
            </div>
            <form id="questTable">
              <div class="form-group">
                  <label for="ans1" id="quest1" class="quest">问题一:</label>
                  <input type="text" class="form-control" id="ans1" placeholder="">
              </div>
              <div class="form-group">
                  <label for="ans2" id="quest2" class="quest">问题二:</label>
                  <input type="text" class="form-control" id="ans2" placeholder="">
              </div>
              <div class="form-group">
                  <label for="ans3" id="quest3" class="quest">问题三:</label>
                  <input type="text" class="form-control" id="ans3" placeholder="">
              </div>
          </form>
          <button type="button" class="btn btn-default" id="depSave">保存</button>
          </div>
          <div style='clear:both'></div>
          <div class="line"></div>
          <div id="enrollWrap">
            <!-- <div id="Table" class="enroll">
            <div class="assoTable">
              <span>社团:</span>
            </div>
            <div class="depWrap">
              <div class="depTable">
                <span>部门1:</span>
                <select class="form-control tSelector" id="department_1">
                    
                    </select>
              </div>
              <div class="depTable">
                <span>部门2:</span>
                <select class="form-control tSelector" id="department_2">
                      
                    </select>
              </div>
            </div> -->
            <!-- <form id="questTable">
              <div class="form-group">
                  <label for="ans1" id="quest1" class="quest">问题一:</label>
                  <input type="text" class="form-control" id="ans1" placeholder="">
              </div>
              <div class="form-group">
                  <label for="ans2" id="quest2" class="quest">问题二:</label>
                  <input type="text" class="form-control" id="ans2" placeholder="">
              </div>
              <div class="form-group">
                  <label for="ans3" id="quest3" class="quest">问题三:</label>
                  <input type="text" class="form-control" id="ans3" placeholder="">
              </div>
          </form> -->
          <!-- <button type="button" class="btn btn-default" id="depSave">保存</button>
          </div> -->
          </div>
          <!-- <table class="table">
              <thead>
                <tr>
                  <th>社团</th>
                  <th>部门1</th>
                  <th>部门2</th>
                  <th>录取状态</th>
                  <th class="control">操作</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <th>
                    科协<span>1</span>
                  </th>
                  <th>
                    网络部
                  </th>
                  <th>
                    电子部
                  </th>
                  <th>#</th>
                  <th class="control-btn"><div class="btn-group btn-group-sm" role="group" aria-label="Small button group">
                    <button type="button" class="btn btn-default" id="depChange">修改</button>
                    <button type="button" class="btn btn-default" id="depDelet">删除</button>
                  </div></th>
                </tr>
              </tbody>
          </table> -->
      </div> <!-- /container -->
    </div>
    <div class="footer">
      <div class="container bottom">
      <p class="test-muted">&copy; 校科协</p>
    </div>
    </div>
    <script src="__ROOT__/js/jquery-1.11.2.min.js"></script>
    <script src="__ROOT__/js/bootstrap.min.js"></script>
    <!--<script src="../../../../public/js/ajax.js"></script>-->

<script>
// 预加载相关信息(完)
function preAdd(){
  //清空
  $("#enrollWrap").html("");
  //取出数组
  if(<?php echo $recruitInfo; ?>){
    var arr = [];
    var a = <?php echo json_encode($recruitInfo); ?>;
    for(var i = 0;i< <?php echo sizeof($recruitInfo); ?>;i++){
      for(j in a[i]){
      arr.push(a[i][j]);
      }
    }
    console.log(arr);
    var times = arr.length/9;
    add();
    return arr;
  }
  
  function add() {
    for(var k = 0;k<times;k++){
      for(var m = 0;m<teamNum.length;m++){
        if(arr[(4+k*9)] == teamNum[m]){
          break;
        }
      }
      var info = "<div id=" + arr[k*9] + " class='enroll'><div class='assoTable'><span>社团:</span><span>" + arr[(4+k*9)] + "</span></div><div class='depWrap'><div class='depTable'><span>部门1:</span><span>" + teamDepartment[m][arr[(2+k*9)]-1] + "</span></div><div class='depTable'><span>部门2:</span><span>" + teamDepartment[m][arr[(3+k*9)]-1] + "</span></div></div><div class='btn-group' role='group' aria-label='Small button group'><button type='button' class='btn btn-default change-btn'>修改<span>" + arr[k*9] + "</span></button><button type='button' class='btn btn-default del-btn'>删除<span>" + arr[k*9] + "</span></button></div></div>"
      $("#enrollWrap").append(info);
    }
  }
}
// 生成部门选项组(完)
function teamSelector(){
  // 更新函数
  function update(num) {
    $(".questcontent").remove();
    if($('#teamselect').val() == '==请选择=='){
      newoption = '';
      $("#chooseTable").css("display","none");
    } else {
      // $("#chooseTable").css("display","block");
      for(var i = 0,newoption = '';i<teamDepartment[num].length;i++){
        newoption += "<option class='choice' value=" + (i+1) + ">" + teamDepartment[num][i] + "</option>";
        }
      for(var s = 0; s < 3; s++){
      $("#quest" + (s+1)).append("<span class='questcontent'>" + questArr[num][s] + "</span>");
      }
    }
    var newSelect_1 = "<select class='form-control tSelector' id='department_1'>" + newoption + "</select>";
    $('#department_1').replaceWith(newSelect_1);
    var newSelect_2 = "<select class='form-control tSelector' id='department_2'>" + newoption + "</select>";
    $('#department_2').replaceWith(newSelect_2);
    
  }
    // 检测变化
  $('#teamselect').change(function(){
    var team = $('#teamselect').val();
    // 检测社团
    for(var i = 0;i<teamNum.length;i++){
      if(teamNum[i] == team){
        break;
      }
    } 
    update(i);
  });
}
// 新增部门及修改后的保存(完)
function addTeam(){
  $("#depSave").click(function(){
    // appendDepInfo();//测试位置
    var association = $("#teamselect").val();
    var department1 = $("#department_1").val();
    var department2 = $("#department_2").val();

    var quest1 = $("#ans1").val();
    var quest2 = $("#ans2").val();
    var quest3 = $("#ans3").val();
    var url = "{:U('Home/User/doRegAssociation')}";
    if($("#teamselect").val() == "==请选择=="){
      alert("请选择一个社团");
    } else if (!quest1||!quest2||!quest3) {
      alert("请先回答问题");
    } else {
      $.ajax({
        type : "POST",
        url : url,
        dataType : "json",
        data : {
            "association" : association,
            "department1" : department1,
            "department2" : department2,
            "quest1" : quest1,
            "quest2" : quest2,
            "quest3" : quest3
        },
        success : function(back){
              
              if(back.status == 1){
                console.log(back);
                appendDepInfo();//正常调用位置
                location.reload();
              } else {
                alert(back.info);
              }
            },
        error : function(){
              alert("异常");
            }
        // 发送请求数据，接收回调数据，反映在界面中
      });
    }
  });
}
//添加社团信息（完）
function appendDepInfo() {
    var idrecord = "<?php echo $recruitInfo[0]['id']; ?>"
    console.log(idrecord);
    var asso = $("#teamselect").val();
    var dep1 = $("#department_1").find('option:selected').text();
    var dep2 = $("#department_2").find('option:selected').text();
    var content = "<tr id=" + idrecord + "><th>" + asso + "</th><th>" + dep1 + "</th><th>" + dep2 + "</th><th>#</th><th><div class='btn-group btn-group-sm' role='group' aria-label='Small button group'><button type='button' class='btn btn-default' id='depChange'>修改</button><button type='button' class='btn btn-default' id='depDelet'>删除</button></div></th></tr>";
    $("tbody").append(content);
}
// 根据所选社团显示部门及问题(完)
function showTeam(){
  $("#depAdd").click(function(){
    if($("#teamselect").val() == "==请选择=="){
      $("#chooseTable").css("display","none");
      alert("请先选择一个社团");
    } else {
      $("#chooseTable").css("display","block");
    }
  })
}
// 更改部门
function changeDep(arr) {
 $("#enrollWrap").find(".change-btn").each(function(){
  $(this).click(function(){
    var id = $(this).find("span").html();
    var newSaveBtn = "<button type='button' class='btn btn-default change-save-btn' id='depChangeSave'>保存<span>" + id + "</span></button>";
    var newCancelBtn = "<button type='button' class='btn btn-default change-cancel-btn' id='depChangeCancel'>取消<span>" + id + "</span></button>";
    var newContent = "<div class='depWrap'><div class='depTable'><span>部门1</span><select class='form-control tSelector' id=" + 'f' + id + "></select></div><div class='depTable'><span>部门2</span><select class='form-control tSelector' id=" + 's' + id + "></select></div></div><form id='questTable'><div class='form-group'><label for='"+ id +"ans1' id='"+ id +"quest1' class='quest'>问题一:</label><input type='text' class='form-control' id='"+ id +"ans1' placeholder=''></div><div class='form-group'><label for='"+ id +"ans2' id='"+ id +"quest2' class='quest'>问题二:</label><input type='text' class='form-control' id='"+ id +"ans2' placeholder=''></div><div class='form-group'><label for='"+ id +"ans3' id='"+ id +"quest3' class='quest'>问题三:</label><input type='text' class='form-control' id='"+ id +"ans3' placeholder=''></div></form>";
    
    // 改内容
    $(this).parent().prev().html(newContent);
    // 改按钮
    $(this).next().replaceWith(newCancelBtn);
    $(this).replaceWith(newSaveBtn);
    //生成选项
    makeOption();
    // 按钮检测
     $("#enrollWrap").find(".change-cancel-btn").each(function(){
          $(this).click(function(){
          location.reload();
          });
        });

    function makeOption(){
      //j为id在arr中所在位置
      for(var j = 0;j<arr.length;j++){
       if(id == arr[j]){
        break;
        }
      }
      //i为所选社团代号
      for(var i = 0;i<teamNum.length;i++){
       if(teamNum[i] == arr[j+4]){
        break;
        }
      }
      for(var k = 0,newoption1 = '',newoption2 = '';k<teamDepartment[i].length;k++){
        if((k+1) == arr[j+2]){
          newoption1 += "<option class='choice' value=" + (k+1) + " " + "selected='selected'>" + teamDepartment[i][k] + "</option>";
        } else {
          newoption1 += "<option class='choice' value=" + (k+1) + ">" + teamDepartment[i][k] + "</option>";
        }
        if((k+1) == arr[j+3]){
          newoption2 += "<option class='choice' value=" + (k+1) + " " + "selected='selected'>" + teamDepartment[i][k] + "</option>";
        } else {
          newoption2 += "<option class='choice' value=" + (k+1) + ">" + teamDepartment[i][k] + "</option>";
        }
      }
      // console.log(newoption);
      $("#"+id).find("#f"+id).html(newoption1);
      $("#"+id).find("#s"+id).html(newoption2);

      makeQuest();
      changesave();

      function makeQuest() {
        for(var m = 1;m<4;m++){
          $("#" + id + "quest" + m).append(questArr[i][m-1]);
          $("#" + id + "ans" + m).val(arr[j+4+m]);
        }
      }

      function changesave(){
        $("#enrollWrap").find(".change-save-btn").each(function(){
          $(this).click(function(){
            var ans1 = $("#" + id + "ans1").val();
            var ans2 = $("#" + id + "ans2").val();
            var ans3 = $("#" + id + "ans3").val();
            var dep1 = $("#f" + id).val();
            var dep2 = $("#s" + id).val();
            $.ajax({
              type : "POST",
              dataType : "json",
              url : "{:U('Home/User/doChangeDepartment')}",
              data : {
                "id" : id,
                "department1" : dep1,
                "department2" : dep2,
                "quest1" : ans1,
                "quest2" : ans2,
                "quest3" : ans3
              },
              success : function(back){
                if(back.status == 1){
                  location.reload();
                } else {
                  alert(back.info);
                }
              },
              error : function(){
                alert("异常");
              }
            });
          });
        });
      }

     }
  });
 });
}
// 删除社团(完)
function deleteTeam() {
  $("#enrollWrap").find(".del-btn").each(function(){
    $(this).click(function(){
      var r = confirm("这将删除本条报名信息，确认删除吗？");
      if(r == true){
        var id = $(this).find("span").html();
      $.ajax({
        type : 'POST',
        url : "{:U('Home/User/delDepartment')}",
        dataType : 'json',
        data : {
          "id" : id
        },
        success : function(back){
          if(back.status == 1){
            $(this).parent().parent().remove();
            location.reload();
          } else if (back.status == 0){
            alert(back.info);
          }
        },
        error : function(){
          alert("异常");
        }
      });
      }
    });
  });
}

$(document).ready(function(){
  // 社团及部门数组
  teamNum = ['科协','外联','办公室'];
  teamDepartment = [];
  teamDepartment[0] = ['电子部','计算机部','网络部'];
  teamDepartment[1] = ['b1','b2','b3'];
  teamDepartment[2] = ['c1','c2','c3'];
  // 社团问题
  questArr = [];
    questArr[0] = ['a?','b?','c?'];
    questArr[1] = ['d','e','f'];

  var update = teamSelector();
  showTeam();
  addTeam();
  var arr = preAdd();
  deleteTeam();
  changeDep(arr);
  // ss();
});

//测试函数
function ss() {
    var a = <?php echo json_encode($recruitInfo); ?>;
    var arr = [];
    for(i in a[0]){
      arr.push(a[0][i]);
    }
    console.log(arr);
}

</script>

  </body>
</html>
